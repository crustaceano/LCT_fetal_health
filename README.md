# LCT_fetal_health

Проект для извлечения признаков из КТГ (FHR/uterus), инференса мультилейбл-моделей CatBoost и интеграции с бэкендом и фронтендом.

## Ссылка на сайт

Проектный сайт/фронтенд: https://your-frontend.example.com

Замените ссылку на реальный домен вашего фронтенда.

## Структура

- `src/model_api/` — сервис инференса (FastAPI) и утилиты
  - `model_app.py` — FastAPI-приложение (`/predict`, `/health`)
  - `model.py` — загрузка CatBoost чекпойнтов и инференс
  - `feature_extraction.py` — извлечение признаков (в т.ч. tsfresh с `n_jobs=0`)
  - `evaluate.py` — функции чтения сигналов и запуска моделей из файлов
  - `evaluate_example.py` — пример локального запуска предсказаний
  - `API_PREDICT.md` — спецификация эндпоинта `/predict`
  - `catboost_checkpoints/` — `.cbm` модели

- `src/backend/` — оркестратор потока (FastAPI)
  - `app.py` — эндпоинты `/ingest`, `/flush`, `/stats`, `/health`, периодическая отправка окна в `model_api`
  - `send_from_files.py` — отправка реальных CSV как поток в `/ingest`
  - `README.md` — документация backend-сервиса

- `data/` — примеры CSV с колонками `time,value`

## Быстрый старт

1) Установите зависимости окружения (минимум):
```bash
pip install fastapi uvicorn catboost tsfresh pandas numpy httpx pydantic
```

2) Запустите сервис моделей (порт 8000):
```bash
uvicorn src.model_api.model_app:app --reload
```

3) Запустите оркестратор потока (порт 9000):
```bash
uvicorn src.backend.app:app --reload --port 9000
```

4) Проверка `/predict` (через curl):
```bash
curl -X POST "http://localhost:8000/predict?threshold=0.5" \
  -F "bpm=@data/hypoxia/10/bpm/20250908-07400001_1.csv" \
  -F "uterus=@data/hypoxia/10/uterus/20250908-07400001_2.csv"
```

5) Отправка реальных CSV как поток в backend и проверка:
```bash
python src/backend/send_from_files.py \
  --bpm data/hypoxia/10/bpm/20250908-07400001_1.csv \
  --uterus data/hypoxia/10/uterus/20250908-07400001_2.csv \
  --speed 2.0

curl http://localhost:9000/stats
curl -X POST http://localhost:9000/flush
```

## API

- Инференс моделей (`model_api`): см. `src/model_api/API_PREDICT.md`
- Оркестратор потока (`backend`):
  - `POST /ingest` — приём событий `{source:"bpm|uterus", time:float, value:float}`
  - `GET /stats` — размеры буферов и последний таймстемп
  - `POST /flush` — принудительная отправка окна в `/predict`
  - `GET /health` — состояние сервиса

## Настройки

Переменные окружения backend:
- `MODEL_API_URL` (по умолчанию `http://localhost:8000/predict`)
- `WINDOW_MINUTES` (по умолчанию `5`)
- `PREDICT_THRESHOLD` (по умолчанию `0.5`)
- `FLUSH_INTERVAL_SECONDS` (по умолчанию = окну)

В `model_api` включён CORS (разрешены все источники для дев). В проде ограничьте `allow_origins` доменами фронтенда.

## Примечания

- CSV должны иметь 2 колонки: `time` (индекс времени) и `value` (значение). Разделитель — запятая. Если у вас другой, адаптируйте загрузчик.
- На Windows tsfresh запускается с `n_jobs=0` для избежания ошибок multiprocessing.

## Выбранное решение

Система анализирует поток КТГ (FHR/uterus), извлекает статистики, сглаживает сигнал, удаляет выбросы и предсказывает вероятности клинических состояний на горизонте ближайших 15 минут. Результат — вероятности по нескольким диагнозам и рекомендации врачу, на что обратить внимание.

## Обработка данных

- Чтение сигналов из файлов/потока (`time`, `value`).
- Нормализация времени, очистка `NaN/Inf`.
- Извлечение классических признаков КТГ (baseline, ускорения/децелерции, вариабельность).
- Доп. признаки с tsfresh (автоматическое извлечение значимых статистик).

## Сглаживание и удаление выбросов

- Сглаживание перед расчётом признаков: скользящее среднее или медианный фильтр (`smooth_signal`).
- Устранение выбросов через робастные меры (медиана/квантили) на уровне окон.

## На большом датасете

- Обучаем модель определять, будут ли следующие 15 минут проблемными (мульти-метки по топ-диагнозам).
- Используем CatBoost (по одному бинарному классификатору на метку; совокупно — Multi-Output).

## Предсказание диагнозов

- Для входного окна считаются вероятности по каждому диагнозу на горизонте 15 минут.
- Выход: `proba_<label>` и `pred_<label>` (порог по умолчанию 0.5) + упорядоченный список меток.

## Выделение статистик

- Ручной отбор важных показателей по графикам (baseline, ускорения, децелерции, STV/LTV).
- Автоматическое извлечение признаков c помощью tsfresh и объединение с ручными.

## Рекомендации

- По итогам предсказаний выводятся рекомендации врачу на основе наиболее вероятных отклонений (метки с наибольшими `proba_*`).
- Порог, окно и сглаживание настраиваемы (через параметры API/скриптов).

## Порядок этапов (схема)

- 4 — Предсказание диагнозов (инференс моделей)
- 2 — Сглаживание и удаление выбросов
- 1 — Обработка данных
- 3 — Обучение классификатора
- 5 — Рекомендации

Примечание: числа соответствуют блокам на схеме; порядок может варьироваться при офлайн-обучении vs онлайн-инференсе.

